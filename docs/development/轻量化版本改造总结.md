# ESP32-S3 MotoBox 轻量化版本改造总结

## 改造概述

根据 `plan_lite.md` 的要求，对ESP32-S3 MotoBox项目进行了轻量化改造，移除了非核心功能，专注于数据采集和4G通信。

## 删除的模块

### 1. 硬件接口模块
- **TFT显示屏** (`src/tft/`) - 移除显示功能，减少功耗和复杂度
- **按钮控制** (`src/btn/`) - 简化硬件接口，减少GPIO占用
- **BLE通信** (`src/ble/`) - 移除蓝牙功能，简化通信架构
- **WiFi服务器** (`src/wifi/`) - 移除WiFi配置功能

### 2. 库文件
- **UI界面库** (`lib/ui/`, `lib/lvgl/`) - 无显示需求，移除UI相关库
- **TFT驱动配置** (`lib/Setup147_ST7789*.h`, `lib/lv_conf.h`) - 移除显示驱动

### 3. 依赖库清理
从 `platformio.ini` 中移除：
- `h2zero/NimBLE-Arduino` - BLE库
- `knolleary/PubSubClient` - MQTT库（已集成到Air780EG）
- `bodmer/TFT_eSPI` - TFT显示库

## 保留的核心模块

### 1. 通信模块
- **Air780EG** - 4G通信 + GNSS定位
- **MQTT** - 通过Air780EG实现数据上报

### 2. 传感器模块
- **IMU (QMI8658)** - 9轴传感器，运动检测
- **罗盘 (QMC5883L)** - 方向检测
- **电池监控** - 电量检测和充电状态

### 3. 存储模块
- **SD卡管理** - 数据存储和固件升级
- **GPS记录器** - 轨迹记录

### 4. 电源管理
- **功耗模式管理** - 智能休眠和唤醒
- **外部电源检测** - 车辆电门检测

### 5. 其他功能
- **LED指示** - 状态指示和调试
- **音频提示** - 语音反馈
- **OTA升级** - 固件更新
- **融合定位** - IMU+GNSS融合算法

## 配置文件修改

### config.h 主要变更
```cpp
// 轻量化版本 - 移除TFT和BLE功能
// #define ENABLE_TFT  // 轻量化版本不需要显示屏
// #define ENABLE_BLE  // 轻量化版本不需要蓝牙
```

### platformio.ini 主要变更
```ini
# 移除BLE_SERVER编译标志
# 启用ENABLE_COMPASS
build_flags = 
    -D CHARGING_STATUS_PIN=17
    -D BAT_PIN=36
    -D RTC_INT_PIN=16
    -D IMU_INT_PIN=34
    -D IIC_SDA_PIN=26
    -D IIC_SCL_PIN=25
    -D ENABLE_SDCARD
    -D ENABLE_AIR780EG
    -D ENABLE_AUDIO
    -D ENABLE_IMU
    -D ENABLE_COMPASS
    -D ENABLE_SLEEP
    -D GSM_RX_PIN=19
    -D GSM_TX_PIN=18
    -D GSM_EN=5
    -D PWM_LED_PIN=33
    -D IIS_S_WS_PIN=23
    -D IIS_S_BCLK_PIN=22
    -D IIS_S_DATA_PIN=21
```

## 代码修改

### main.cpp 主要变更
1. 移除BLE相关包含和初始化
2. 移除TFT相关代码
3. 移除WiFi任务
4. 移除按钮处理逻辑
5. 简化任务结构，只保留系统监控和数据处理任务

### device.h/device.cpp 修改
1. 移除BLE相关包含
2. 移除TFT相关包含

## 编译结果

轻量化版本编译成功：
- **RAM使用**: 16.4% (53,832 / 327,680 bytes)
- **Flash使用**: 74.2% (1,458,829 / 1,966,080 bytes)

## 功能验证

### 保留功能清单
- ✅ Air780EG 4G通信
- ✅ GNSS定位
- ✅ IMU传感器
- ✅ 罗盘功能
- ✅ SD卡存储
- ✅ GPS记录器
- ✅ 电源管理
- ✅ LED指示
- ✅ 音频提示
- ✅ OTA升级
- ✅ 融合定位

### 移除功能确认
- ❌ TFT显示
- ❌ BLE通信
- ❌ WiFi配置
- ❌ 按钮控制
- ❌ UI界面

## 优势总结

1. **简化架构** - 移除复杂的显示和交互功能
2. **降低功耗** - 减少不必要的模块和GPIO占用
3. **提高稳定性** - 减少潜在故障点
4. **专注核心** - 突出数据采集和通信功能
5. **易于维护** - 代码结构更清晰

## 后续优化建议

1. **进一步功耗优化** - 可考虑移除不必要的库依赖
2. **代码清理** - 移除未使用的变量和函数
3. **内存优化** - 优化数据结构和缓冲区大小
4. **测试验证** - 全面测试各项核心功能

## 版本信息

- **轻量化版本**: v5.0.0
- **基础版本**: v4.2.0
- **改造日期**: 2025-09-01
- **编译环境**: esp32-air780eg
