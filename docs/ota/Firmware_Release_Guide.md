# ESP32-S3 MotoBox 固件发布和升级完整指南

## 🎯 概述

本指南介绍ESP32-S3 MotoBox项目的固件发布流程和SD卡升级功能。系统支持自动版本管理，只识别`motobox_v*.bin`格式的固件文件，并能正确处理`v4.0.0+697`这样的版本号格式。

## 🔧 固件发布工具

### 工具功能
- ✅ **自动编译**：集成PlatformIO编译流程
- ✅ **版本管理**：从`src/version.h`读取当前版本
- ✅ **版本比较**：支持`v4.0.0+697`格式的版本号比较
- ✅ **自动发布**：生成`motobox_v*.bin`格式的发布文件
- ✅ **版本清理**：自动清理旧版本文件

### 使用方法

#### 1. 检查版本状态
```bash
python3 tools/firmware_release.py --status
```

输出示例：
```
🔍 版本状态检查:
   当前版本: v4.0.0+697
   最新发布: 4.1.0
   状态: ❌ 当前版本较旧
```

#### 2. 创建发布版本
```bash
# 使用当前版本号发布
python3 tools/firmware_release.py --release

# 指定版本号发布
python3 tools/firmware_release.py --release --version v4.2.0

# 强制发布（即使版本号相同）
python3 tools/firmware_release.py --release --force
```

#### 3. 列出所有发布版本
```bash
python3 tools/firmware_release.py --list
```

输出示例：
```
📋 已发布的固件版本:
--------------------------------------------------------------------------------
版本号                  文件名                            大小         发布时间                
--------------------------------------------------------------------------------
4.1.0                motobox_v4.1.0.bin             1.04MB     2025-07-14 18:44:08
4.0.0+2              motobox_v4.0.0+2.bin           1.04MB     2025-07-14 18:43:08
```

#### 4. 清理旧版本
```bash
# 保留最新5个版本，删除其他
python3 tools/firmware_release.py --clean 5
```

## 📊 版本号格式支持

### 支持的版本号格式
- `v4.0.0` - 标准语义化版本
- `4.0.0` - 无v前缀版本
- `v4.0.0+697` - 带构建号版本
- `4.0.0+697` - 无v前缀带构建号版本

### 版本比较规则
1. **主版本号**：4.x.x > 3.x.x
2. **次版本号**：4.1.x > 4.0.x
3. **修订版本号**：4.0.1 > 4.0.0
4. **构建号**：4.0.0+697 > 4.0.0+696

### 版本比较示例
```
v4.1.0 > v4.0.0+697 > v4.0.0+696 > v4.0.0 > v3.9.9
```

## 🔄 SD卡升级功能

### 支持的固件格式
**只支持 `motobox_v*.bin` 格式**

✅ 支持的文件名：
- `motobox_v4.0.0.bin`
- `motobox_v4.1.0.bin`
- `motobox_v4.0.0+697.bin`

❌ 不支持的文件名：
- `firmware.bin`
- `firmware_v4.0.0.bin`
- `esp32_v4.0.0.bin`

### 升级流程

#### 1. 准备固件文件
```bash
# 发布固件
python3 tools/firmware_release.py --release --version v4.2.0

# 复制到SD卡
cp releases/motobox_v4.2.0.bin /path/to/sdcard/
```

#### 2. 设备升级过程
1. **插入SD卡**并重启设备
2. **自动扫描**：系统扫描SD卡中的`motobox_v*.bin`文件
3. **版本比较**：比较固件版本与当前版本
4. **电量检查**：确认电池电量≥90%
5. **开始升级**：播放3声短促提示音
6. **升级进行**：显示进度，每20%播放提示音
7. **升级完成**：播放成功提示音，自动重启

#### 3. 升级日志示例
```
[SDCardOTA] 开始检查SD卡升级
[SDCardOTA] 🔍 扫描SD卡中的固件文件...
[SDCardOTA] ✅ 找到固件: motobox_v4.2.0.bin (版本: v4.2.0, 大小: 1087424 字节)
[SDCardOTA] 📊 扫描完成，找到 1 个有效固件文件
[SDCardOTA] 选择的固件: motobox_v4.2.0.bin (版本: v4.2.0)
[SDCardOTA] 当前电池电量: 95%
[SDCardOTA] ✅ 所有升级条件满足，开始升级到版本: v4.2.0
[SDCardOTA] 🔄 开始升级固件: motobox_v4.2.0.bin
[SDCardOTA] 升级进度: 20% (217485/1087424 字节)
[SDCardOTA] 升级进度: 40% (434970/1087424 字节)
[SDCardOTA] 升级进度: 60% (652455/1087424 字节)
[SDCardOTA] 升级进度: 80% (869940/1087424 字节)
[SDCardOTA] 升级进度: 100% (1087424/1087424 字节)
[SDCardOTA] ✅ 固件升级成功！
[SDCardOTA] 📊 升级统计:
[SDCardOTA]   - 源文件: motobox_v4.2.0.bin
[SDCardOTA]   - 版本: v4.0.0+697 → v4.2.0
[SDCardOTA]   - 写入字节: 1087424/1087424
[SDCardOTA] 🔄 设备即将重启到新版本...
```

## 🎵 语音提示说明

| 提示音 | 含义 | 描述 |
|--------|------|------|
| 🔊 3声短促音 | 开始升级 | 找到新固件，条件满足，开始升级 |
| 🔊 2声中等音 | 升级进行中 | 正在写入固件数据 |
| 🔊 上升音调 | 升级成功 | 固件升级完成，即将重启 |
| 🔊 长声低音 | 升级失败 | 升级过程出错 |
| 🔊 单声短促 | 进度提示 | 每20%进度播放一次 |

## 📋 完整工作流程

### 开发阶段
1. **修改代码**并更新`src/version.h`中的版本号
2. **检查状态**：`python3 tools/firmware_release.py --status`
3. **发布固件**：`python3 tools/firmware_release.py --release`
4. **验证发布**：`python3 tools/firmware_release.py --list`

### 测试阶段
1. **复制固件**到SD卡：`cp releases/motobox_v*.bin /path/to/sdcard/`
2. **插入SD卡**到测试设备
3. **重启设备**并观察升级过程
4. **验证版本**：检查设备启动后的版本信息

### 生产部署
1. **批量复制**固件文件到多张SD卡
2. **分发SD卡**给现场设备
3. **现场升级**：插卡重启即可自动升级
4. **收集反馈**：通过日志或MQTT监控升级状态

## ⚠️ 注意事项

### 版本管理
1. **版本号递增**：确保新版本号大于当前版本
2. **构建号管理**：使用构建号区分同一版本的不同构建
3. **版本标记**：重要版本应该有清晰的标记和说明

### 升级安全
1. **电量检查**：确保设备电量≥90%
2. **文件完整性**：确保固件文件没有损坏
3. **备份策略**：保留多个版本以便回退
4. **测试验证**：新版本应该充分测试后再发布

### 文件管理
1. **定期清理**：使用`--clean`参数清理旧版本
2. **存储空间**：注意SD卡和发布目录的存储空间
3. **文件命名**：严格遵循`motobox_v*.bin`格式

## 🔍 故障排除

### 发布工具问题

**Q: 编译失败**
```bash
# 检查编译环境
pio run -e esp32-air780eg

# 清理后重新编译
pio run -e esp32-air780eg -t clean
```

**Q: 版本号解析错误**
- 检查`src/version.h`中的`FIRMWARE_VERSION`定义
- 确保版本号格式正确

### 升级功能问题

**Q: 设备不升级**
- 检查固件文件名是否为`motobox_v*.bin`格式
- 确认版本号是否比当前版本新
- 检查电池电量是否≥90%

**Q: 升级失败**
- 检查固件文件是否完整
- 确认SD卡空间是否充足
- 查看串口日志了解具体错误

## 📈 最佳实践

### 版本发布策略
1. **主版本**：重大功能更新或架构变更
2. **次版本**：新功能添加或重要改进
3. **修订版本**：Bug修复或小改进
4. **构建号**：同一版本的不同构建

### 测试策略
1. **单元测试**：确保核心功能正常
2. **集成测试**：验证升级流程完整性
3. **现场测试**：在实际环境中验证
4. **回归测试**：确保新版本不破坏现有功能

### 部署策略
1. **灰度发布**：先在少量设备上测试
2. **分批升级**：避免同时升级所有设备
3. **监控告警**：实时监控升级状态
4. **快速回退**：准备回退方案

这套固件发布和升级系统为ESP32-S3 MotoBox项目提供了完整的版本管理解决方案，支持从开发到生产的全流程自动化管理。
