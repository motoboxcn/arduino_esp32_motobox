# BLE功能使用指南

## 概述

本系统新增了蓝牙BLE功能，允许客户端通过蓝牙连接获取设备的实时数据，包括GPS位置信息、电池电量信息和IMU倾角信息。

## 功能特性

### 1. BLE服务器
- 设备名称：`MotoBox-{设备ID}`（例如：`MotoBox-A1B2C3D4E5F6`）
- 服务UUID：`12345678-1234-1234-1234-123456789ABC`
- 支持客户端连接和断开自动管理
- 连接时停止广播以节省功耗

### 2. 数据特征值

#### GPS位置信息
- **特征值UUID**: `12345678-1234-1234-1234-123456789ABD`
- **数据类型**: JSON格式
- **更新频率**: 1秒
- **数据内容**:
  ```json
  {
    "lat": 39.9042,      // 纬度
    "lng": 116.4074,     // 经度
    "alt": 50.5,         // 海拔(米)
    "spd": 25.3,         // 速度(km/h)
    "crs": 180.0,        // 航向(度)
    "sat": 8,            // 卫星数量
    "valid": true,       // 数据有效性
    "ts": 1234567890     // 时间戳
  }
  ```

#### 电池电量信息
- **特征值UUID**: `12345678-1234-1234-1234-123456789ABE`
- **数据类型**: JSON格式
- **更新频率**: 5秒
- **数据内容**:
  ```json
  {
    "voltage": 4200,     // 电池电压(mV)
    "percentage": 85,    // 电池百分比(0-100)
    "charging": false,   // 充电状态
    "external": true,    // 外部电源状态
    "ts": 1234567890     // 时间戳
  }
  ```

#### IMU倾角信息
- **特征值UUID**: `12345678-1234-1234-1234-123456789ABF`
- **数据类型**: JSON格式
- **更新频率**: 100ms
- **数据内容**:
  ```json
  {
    "pitch": 2.5,        // 俯仰角(度)
    "roll": -1.2,        // 横滚角(度)
    "yaw": 45.8,         // 偏航角(度)
    "accel": {
      "x": 0.1,          // X轴加速度(m/s²)
      "y": 0.2,          // Y轴加速度(m/s²)
      "z": 9.8           // Z轴加速度(m/s²)
    },
    "gyro": {
      "x": 0.01,         // X轴角速度(rad/s)
      "y": 0.02,         // Y轴角速度(rad/s)
      "z": 0.03          // Z轴角速度(rad/s)
    },
    "valid": true,       // 数据有效性
    "ts": 1234567890     // 时间戳
  }
  ```

## 客户端连接步骤

### 1. 扫描设备
- 使用BLE扫描功能搜索设备名称 `MotoBox-{设备ID}`
- 或搜索服务UUID `12345678-1234-1234-1234-123456789ABC`

### 2. 连接设备
- 连接到MotoBox设备
- 系统会自动停止广播以节省功耗

### 3. 发现服务
- 发现主服务：`12345678-1234-1234-1234-123456789ABC`
- 发现三个特征值：
  - GPS位置：`12345678-1234-1234-1234-123456789ABD`
  - 电池电量：`12345678-1234-1234-1234-123456789ABE`
  - IMU倾角：`12345678-1234-1234-1234-123456789ABF`

### 4. 订阅数据
- 对需要的特征值启用通知(Notify)
- 系统会按相应频率推送数据更新

### 5. 断开连接
- 客户端断开连接后，设备会自动重新开始广播

## 配置选项

### 编译时配置
在 `config.h` 中可以配置以下参数：

```cpp
#define BLE_DEVICE_NAME_PREFIX            "MotoBox-"          // BLE设备名称前缀
#define BLE_SERVICE_UUID                  "12345678-1234-1234-1234-123456789ABC"  // 主服务UUID
#define BLE_CHAR_GPS_UUID                 "12345678-1234-1234-1234-123456789ABD"  // GPS位置特征UUID
#define BLE_CHAR_BATTERY_UUID             "12345678-1234-1234-1234-123456789ABE"  // 电池电量特征UUID
#define BLE_CHAR_IMU_UUID                 "12345678-1234-1234-1234-123456789ABF"  // IMU倾角特征UUID
#define BLE_UPDATE_INTERVAL               1000                // BLE数据更新间隔（毫秒）
#define BLE_DEBUG_ENABLED                 false               // BLE调试输出
```

### 启用/禁用BLE功能
```cpp
#define ENABLE_BLE  // 启用蓝牙功能
// #define ENABLE_BLE  // 禁用蓝牙功能
```

## 调试功能

### 启用调试输出
在 `config.h` 中设置：
```cpp
#define BLE_DEBUG_ENABLED true
```

### 状态查询
可以通过串口命令查询BLE状态：
- 连接状态
- 广播状态
- 数据有效性
- 客户端连接数

## 功耗优化

1. **连接时停止广播**：客户端连接后自动停止BLE广播以节省功耗
2. **按需更新**：只有在有客户端连接时才推送数据更新
3. **数据变化检测**：只有当数据发生变化时才推送更新，避免无效传输

## 注意事项

1. **数据源依赖**：BLE功能依赖于GPS、IMU和电池模块的正常工作
2. **连接管理**：系统自动管理客户端连接和断开
3. **数据格式**：所有数据均采用JSON格式，便于客户端解析
4. **时间戳**：所有数据都包含时间戳，便于客户端进行数据同步

## 故障排除

### 常见问题

1. **BLE初始化失败**
   - 检查ESP32是否支持BLE功能
   - 确认编译配置正确

2. **客户端无法连接**
   - 检查设备名称是否正确
   - 确认服务UUID是否匹配
   - 检查设备是否在广播状态

3. **数据不更新**
   - 确认客户端已正确订阅特征值
   - 检查数据源模块是否正常工作
   - 查看调试输出确认数据有效性

### 调试命令
通过串口可以执行以下调试命令：
- 查看BLE状态
- 强制更新数据
- 重置BLE连接
