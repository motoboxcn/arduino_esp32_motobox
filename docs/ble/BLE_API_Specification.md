# MotoBox BLE API 规范文档

## 📋 文档版本

- **版本**: v1.0.0
- **更新日期**: 2024年
- **固件版本**: v4.2.0+475及以上
- **作者**: MotoBox开发团队

---

## 📡 BLE服务概览

### 服务信息

- **服务UUID**: `12345678-1234-1234-1234-123456789ABC`
- **设备名称**: `MotoBox-[DeviceID]`
- **连接特性**: 支持单客户端连接，自动重连

### 特征值列表

| 特征值名称 | UUID | 权限 | 更新频率 | 说明 |
|-----------|------|------|---------|------|
| GPS位置 | `...ABD` | Read, Notify | 1秒 | GPS定位数据 |
| 电池状态 | `...ABE` | Read, Notify | 5秒 | 电池电量和充电状态 |
| IMU数据 | `...ABF` | Read, Notify | 100ms | IMU倾角和加速度数据 |
| **融合定位** | `...AC0` | Read, Notify | **50ms (20Hz)** | **Madgwick融合定位数据（新增）** |
| **系统状态** | `...AC1` | Read, Notify | **2秒** | **系统运行状态和统计信息（新增）** |

---

## 📊 数据格式规范

所有特征值数据均采用JSON格式编码，UTF-8编码。

### 1. GPS位置数据 (`...ABD`)

**数据结构**:
```json
{
  "lat": 39.904200,        // 纬度（度）
  "lng": 116.407400,       // 经度（度）
  "alt": 45.2,             // 海拔（米）
  "spd": 25.5,             // 速度（km/h）
  "crs": 135.0,            // 航向（度，0-360）
  "sat": 12,               // 卫星数量
  "valid": true,           // 数据有效性
  "ts": 123456789          // 时间戳（毫秒）
}
```

**字段说明**:

| 字段 | 类型 | 单位 | 范围 | 说明 |
|------|------|------|------|------|
| lat | number | 度 | -90 ~ 90 | 纬度，南纬为负 |
| lng | number | 度 | -180 ~ 180 | 经度，西经为负 |
| alt | number | 米 | - | 海拔高度 |
| spd | number | km/h | >= 0 | 地面速度 |
| crs | number | 度 | 0 ~ 360 | 航向，正北为0° |
| sat | number | 个 | 0 ~ 32 | 可见卫星数量 |
| valid | boolean | - | - | GPS数据是否有效 |
| ts | number | ms | - | 设备运行时间戳 |

---

### 2. 电池状态数据 (`...ABE`)

**数据结构**:
```json
{
  "voltage": 4200,         // 电池电压（mV）
  "percentage": 85,        // 电量百分比（0-100）
  "charging": true,        // 是否正在充电
  "external": true,        // 是否连接外部电源
  "ts": 123456789          // 时间戳（毫秒）
}
```

**字段说明**:

| 字段 | 类型 | 单位 | 范围 | 说明 |
|------|------|------|------|------|
| voltage | number | mV | 3000 ~ 4200 | 电池电压 |
| percentage | number | % | 0 ~ 100 | 剩余电量百分比 |
| charging | boolean | - | - | 是否正在充电 |
| external | boolean | - | - | 是否连接外部电源 |
| ts | number | ms | - | 设备运行时间戳 |

---

### 3. IMU数据 (`...ABF`)

**数据结构**:
```json
{
  "pitch": -15.2,          // 俯仰角（度）
  "roll": 25.8,            // 横滚角（度）
  "yaw": 180.0,            // 偏航角（度）
  "accel": {               // 加速度（m/s²）
    "x": 0.1,
    "y": -0.05,
    "z": 9.81
  },
  "gyro": {                // 角速度（rad/s）
    "x": 0.01,
    "y": -0.02,
    "z": 0.00
  },
  "valid": true,           // 数据有效性
  "ts": 123456789          // 时间戳（毫秒）
}
```

**字段说明**:

| 字段 | 类型 | 单位 | 说明 |
|------|------|------|------|
| pitch | number | 度 | 俯仰角，前倾为正 |
| roll | number | 度 | 横滚角，右倾为正 |
| yaw | number | 度 | 偏航角，0-360° |
| accel | object | m/s² | 三轴加速度 |
| gyro | object | rad/s | 三轴角速度 |
| valid | boolean | - | 数据有效性 |
| ts | number | ms | 设备运行时间戳 |

---

### 4. 🔥 融合定位数据 (`...AC0`) **[新增]**

这是最核心的数据特征值，包含完整的Madgwick AHRS融合定位信息和debug数据。

**数据结构**:
```json
{
  "pos": [39.904200, 116.407400, 45.2],  // [纬度, 经度, 海拔]
  "mov": [15.5, 135.0],                  // [速度(m/s), 航向(度)]
  "raw": [25.8, -15.2, 180.0],          // Madgwick原始输出 [roll, pitch, yaw]
  "kal": [24.3, -14.8, 179.5],          // Kalman滤波后 [roll, pitch, yaw]
  "lean": [35.2, 2.5],                  // [倾斜角(度), 倾斜角速度(度/s)]
  "acc": [2.5, 0.8],                    // [前进加速度, 侧向加速度] (m/s²)
  "ipos": [12.5, -8.3, 0.2],           // 积分位置 [x, y, z] (m)
  "ivel": [2.1, -1.5, 0.0],            // 积分速度 [x, y, z] (m/s)
  "src": 1,                             // 定位来源 (0=GPS, 1=GPS+IMU, 2=惯导)
  "kf": true,                           // Kalman滤波启用状态
  "v": true,                            // 数据有效性
  "ts": 123456789                       // 时间戳（毫秒）
}
```

**字段详解**:

| 字段 | 类型 | 说明 | 备注 |
|------|------|------|------|
| pos[0] | number | 融合后的纬度（度） | 结合GPS和IMU的最优估计 |
| pos[1] | number | 融合后的经度（度） | 结合GPS和IMU的最优估计 |
| pos[2] | number | 海拔（米） | - |
| mov[0] | number | 速度（m/s） | 融合后的速度估计 |
| mov[1] | number | 航向角（度，0-360） | 融合后的航向估计 |
| raw[0] | number | Madgwick原始横滚角（度） | 未经Kalman滤波 |
| raw[1] | number | Madgwick原始俯仰角（度） | 未经Kalman滤波 |
| raw[2] | number | Madgwick原始偏航角（度） | 未经Kalman滤波 |
| kal[0] | number | Kalman滤波后横滚角（度） | 更平滑，滞后更小 |
| kal[1] | number | Kalman滤波后俯仰角（度） | 更平滑，滞后更小 |
| kal[2] | number | Kalman滤波后偏航角（度） | 更平滑，滞后更小 |
| lean[0] | number | 摩托车倾斜角（度） | 转弯时的车身倾角 |
| lean[1] | number | 倾斜角速度（度/秒） | 倾斜变化率 |
| acc[0] | number | 前进加速度（m/s²） | 纵向加速度 |
| acc[1] | number | 侧向加速度（m/s²） | 横向加速度 |
| ipos[0-2] | number | 相对位置积分（米） | Debug用，相对起点 |
| ivel[0-2] | number | 速度积分（m/s） | Debug用，IMU积分速度 |
| src | number | **定位来源标志** | **0=纯GPS, 1=GPS+IMU融合, 2=纯惯导（GPS丢失）** |
| kf | boolean | Kalman滤波是否启用 | - |
| v | boolean | 数据有效性 | - |
| ts | number | 时间戳（毫秒） | - |

**定位来源说明** (`src` 字段):
- `0` - **纯GPS定位**: GPS信号良好，仅使用GPS数据
- `1` - **GPS+IMU融合**: GPS和IMU组合，提供最佳精度
- `2` - **纯惯导模式**: GPS信号丢失，仅使用IMU进行航位推算

---

### 5. 🔥 系统状态数据 (`...AC1`) **[新增]**

包含系统运行状态、模块状态、内存使用、统计数据等完整信息。

**数据结构**:
```json
{
  "mode": 0,               // 运行模式 (0=正常, 1=调试, 2=校准)
  "up": 3600,              // 运行时间（秒）
  "loop": 360000,          // 主循环计数
  "st": {                  // 模块状态
    "gps": 1,              // GPS状态 (0=无效, 1=有效, 2=丢失)
    "imu": 1,              // IMU状态 (0=无效, 1=有效, 2=校准中)
    "bat": 2,              // 电池状态 (0=低电量, 1=正常, 2=充电中)
    "fus": 1               // 融合状态 (0=未初始化, 1=正常, 2=GPS丢失)
  },
  "mem": {                 // 内存状态
    "free": 112540,        // 空闲堆内存（bytes）
    "kb": 109              // 空闲堆内存（KB）
  },
  "stats": {               // 统计数据
    "dist": 1250.5,        // 总行驶距离（米）
    "maxspd": 15.2,        // 最大速度（m/s）
    "maxln": 45.3,         // 最大倾斜角（度）
    "gps": 1200,           // GPS更新次数
    "imu": 36000,          // IMU更新次数
    "fus": 36000           // 融合更新次数
  },
  "err": 0,                // 错误代码 (0=无错误)
  "msg": "",               // 错误消息
  "ts": 123456789          // 时间戳（毫秒）
}
```

**字段详解**:

| 字段 | 类型 | 说明 | 取值范围 |
|------|------|------|----------|
| mode | number | 运行模式 | 0=正常, 1=调试, 2=校准 |
| up | number | 设备运行时间（秒） | >= 0 |
| loop | number | 主循环执行次数 | >= 0 |
| st.gps | number | GPS模块状态 | 0=无效, 1=有效, 2=丢失 |
| st.imu | number | IMU模块状态 | 0=无效, 1=有效, 2=校准中 |
| st.bat | number | 电池状态 | 0=低电量(<20%), 1=正常, 2=充电中 |
| st.fus | number | 融合定位状态 | 0=未初始化, 1=正常, 2=GPS丢失 |
| mem.free | number | 空闲堆内存（字节） | - |
| mem.kb | number | 空闲堆内存（KB） | - |
| stats.dist | number | 总行驶距离（米） | >= 0 |
| stats.maxspd | number | 最大速度（m/s） | >= 0 |
| stats.maxln | number | 最大倾斜角（度） | 0 ~ 90 |
| stats.gps | number | GPS更新计数 | >= 0 |
| stats.imu | number | IMU更新计数 | >= 0 |
| stats.fus | number | 融合更新计数 | >= 0 |
| err | number | 错误代码 | 0=无错误 |
| msg | string | 错误消息 | 最长32字符 |
| ts | number | 时间戳（毫秒） | - |

---

## 🔌 连接流程

### 1. 扫描设备
```
搜索BLE设备名称前缀: "MotoBox-"
服务UUID: 12345678-1234-1234-1234-123456789ABC
```

### 2. 建立连接
```
1. 连接到设备
2. 发现服务和特征值
3. 启用需要的特征值的Notify
```

### 3. 订阅特征值
按需订阅以下特征值（建议订阅顺序）：
1. **融合定位数据** (`...AC0`) - 最高优先级，20Hz实时数据
2. **系统状态** (`...AC1`) - 监控系统运行状态
3. GPS位置 (`...ABD`) - 可选，已包含在融合数据中
4. 电池状态 (`...ABE`) - 可选
5. IMU数据 (`...ABF`) - 可选，已包含在融合数据中

### 4. 数据接收
```
1. 监听特征值的onCharacteristicValueChanged事件
2. 解析JSON数据
3. 更新UI显示
```

---

## ⚠️ 注意事项

### 数据更新频率

| 特征值 | 频率 | 说明 |
|--------|------|------|
| 融合定位 | 50ms (20Hz) | **最高频率**，适合实时显示 |
| IMU | 100ms (10Hz) | 高频姿态数据 |
| GPS | 1秒 (1Hz) | 标准GPS更新率 |
| 系统状态 | 2秒 (0.5Hz) | 低频监控数据 |
| 电池 | 5秒 (0.2Hz) | 低频状态数据 |

### 性能建议

1. **优先使用融合定位数据**: 融合数据已包含GPS和IMU信息，无需重复订阅
2. **按需订阅**: 根据实际需求选择订阅的特征值，减少数据传输
3. **数据缓存**: 对于低频数据（如电池状态），建议在客户端缓存
4. **断线重连**: 实现自动重连机制，处理蓝牙连接断开情况

### 数据有效性

- 始终检查数据的 `valid` 或 `v` 字段
- GPS丢失时，融合数据的 `src` 字段会变为 `2`（纯惯导模式）
- 惯导模式下位置精度会随时间递减，建议提示用户

---

## 📝 错误码定义

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| 0 | 无错误 | - |
| 1-99 | 系统错误 | 重启设备 |
| 100-199 | GPS错误 | 检查GPS天线 |
| 200-299 | IMU错误 | 校准IMU |
| 300-399 | 电池错误 | 检查电池连接 |

---

## 📚 相关文档

- [微信小程序集成指南](./Mini_Program_Integration_Guide.md)
- [TypeScript类型定义](./types.d.ts)
- [示例代码](./examples/)

---

## 📮 技术支持

如有问题，请联系 MotoBox 开发团队。

