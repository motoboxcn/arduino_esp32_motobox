# 统一遥测数据格式 v2.1

## 概述

ESP32设备现已采用统一的遥测数据格式，通过MQTT发送结构化的JSON数据到服务端。

## JSON数据结构

### 完整数据格式

```json
{
  "device_id": "3C8427C153FC",
  "firmware": "v4.3.0+673",
  "hardware": "dev",
  "location": {
    "lat": 31.181322,
    "lng": 120.667177,
    "alt": 19.7,
    "speed": 0.513889,
    "course": 135.8,
    "satellites": 29,
    "hdop": 1.2,
    "type": "GNSS",
    "gps_time_string": "2025-11-01T05:29:33Z"
  },
  "sensors": {
    "imu": {
      "accel_x": 0.1,
      "accel_y": 0.2,
      "accel_z": 9.8,
      "gyro_x": 0.01,
      "gyro_y": 0.02,
      "gyro_z": 0.03,
      "roll": 1.2,
      "pitch": -0.8,
      "yaw": 45.6
    },
    "compass": {
      "heading": 45.6,
      "mag_x": 12.3,
      "mag_y": 45.6,
      "mag_z": 78.9
    }
  },
  "system": {
    "battery": 12600,
    "battery_pct": 85,
    "charging": false,
    "external_power": true,
    "signal": 85,
    "uptime": 3600,
    "free_heap": 150000
  },
  "modules": {
    "wifi": false,
    "ble": true,
    "gsm": true,
    "imu": true,
    "compass": true
  }
}
```

## 字段说明

### 设备信息
- `device_id`: 设备唯一标识符
- `firmware`: 固件版本号
- `hardware`: 硬件版本标识

### 位置数据 (location)
- `lat`: 纬度 (double)
- `lng`: 经度 (double)
- `alt`: 海拔高度 (float, 米)
- `speed`: 速度 (float, m/s)
- `course`: 航向角 (float, 度)
- `satellites`: 卫星数量 (uint8_t)
- `hdop`: 水平精度因子 (float)
- `type`: 定位类型 ("GNSS", "WIFI", "LBS")
- `gps_time_string`: GPS时间字符串

### 传感器数据 (sensors)

#### IMU数据 (imu)
- `accel_x/y/z`: 加速度 (float, m/s²)
- `gyro_x/y/z`: 角速度 (float, rad/s)
- `roll/pitch/yaw`: 姿态角 (float, 度)

#### 罗盘数据 (compass)
- `heading`: 磁北方向角 (float, 度)
- `mag_x/y/z`: 磁场强度 (float, μT)

### 系统状态 (system)
- `battery`: 电池电压 (int, mV)
- `battery_pct`: 电池百分比 (int, %)
- `charging`: 充电状态 (bool)
- `external_power`: 外部电源状态 (bool)
- `signal`: 信号强度 (int, %)
- `uptime`: 运行时间 (uint32_t, 秒)
- `free_heap`: 可用内存 (uint32_t, 字节)

### 模块状态 (modules)
- `wifi`: WiFi模块状态 (bool)
- `ble`: 蓝牙模块状态 (bool)
- `gsm`: GSM模块状态 (bool)
- `imu`: IMU模块状态 (bool)
- `compass`: 罗盘模块状态 (bool)

## 数据有效性

每个数据模块都有内置的 `valid` 标志：
- `location.valid`: 位置数据有效性
- `sensors.imu.valid`: IMU数据有效性
- `sensors.compass.valid`: 罗盘数据有效性

只有 `valid=true` 的数据才会包含在JSON中。

## 定位类型说明

### GNSS定位
- 使用GPS/北斗等卫星定位
- 精度最高，但需要良好的天空视野
- `satellites > 0` 时可用

### WiFi定位
- 基于周围WiFi热点的位置推算
- 室内或城市环境精度较好
- 作为GNSS的补充定位方式

### LBS定位
- 基于基站信号的位置推算
- 精度较低，但覆盖范围广
- 作为最后的兜底定位方式

## MQTT发布

### 主题格式
```
vehicle/v1/{device_id}/telemetry
```

### 发布频率
根据功耗模式动态调整：
- 休眠模式: 不发送
- 基本模式: 15秒间隔
- 正常模式: 5秒间隔
- 运动模式: 2秒间隔

## 版本历史

- v2.1 (2025-11-03): 统一遥测数据格式，添加定位类型字段
- v2.0: 模块化数据结构
- v1.x: 分离的GPS/IMU数据格式
