# 重力补偿算法详解

## 问题背景

IMU传感器测量的是**总加速度**，包括重力加速度和运动加速度。当设备倾斜时，重力会分解到各个轴，导致无法准确获取车辆的真实运动加速度。

## 传统倾角计算的问题

### 错误方法：
```cpp
// 直接使用原始加速度数据
float forwardAccel = imuData.accel[0];  // 包含重力分量
float lateralAccel = imuData.accel[1];  // 包含重力分量
```

### 问题：
1. **静止时**：设备倾斜会导致非零加速度读数
2. **运动时**：重力分量干扰真实运动加速度
3. **转弯时**：侧向加速度不准确

## 重力补偿的正确方法

### 1. 重力分解计算
```cpp
// 根据设备姿态角计算重力在各轴的分量
gravityX = -sin(pitch) * 9.8f;           // 俯仰角影响X轴
gravityY = sin(roll) * cos(pitch) * 9.8f; // 横滚角影响Y轴
gravityZ = cos(roll) * cos(pitch) * 9.8f; // 重力在Z轴的分量
```

### 2. 运动加速度提取
```cpp
// 从总加速度中减去重力分量
motionAccel[0] = totalAccel[0] - gravityX;  // 纯前进/后退加速度
motionAccel[1] = totalAccel[1] - gravityY;  // 纯左右转弯加速度
motionAccel[2] = totalAccel[2] - gravityZ;  // 纯上下运动加速度
```

## 实际效果对比

### 场景1：车辆静止在斜坡上（Roll=30°, Pitch=0°）

**倾角计算方法**：
- X轴：0.0 m/s²
- Y轴：4.9 m/s²（重力分量）
- Z轴：8.5 m/s²（重力分量）
- **结果**：误认为车辆在侧向加速

**重力补偿方法**：
- 重力分量：X=0.0, Y=4.9, Z=8.5 m/s²
- 运动加速度：X=0.0, Y=0.0, Z=0.0 m/s²
- **结果**：正确识别为静止状态

### 场景2：车辆在水平路面加速（Roll=0°, Pitch=0°）

**倾角计算方法**：
- 总加速度：X=2.0, Y=0.0, Z=9.8 m/s²
- **问题**：无法区分重力和运动加速度

**重力补偿方法**：
- 重力分量：X=0.0, Y=0.0, Z=9.8 m/s²
- 运动加速度：X=2.0, Y=0.0, Z=0.0 m/s²
- **结果**：准确获取前进加速度

### 场景3：车辆转弯（Roll=0°, Pitch=0°）

**倾角计算方法**：
- 总加速度：X=0.0, Y=3.0, Z=9.8 m/s²
- **问题**：侧向加速度被重力干扰

**重力补偿方法**：
- 重力分量：X=0.0, Y=0.0, Z=9.8 m/s²
- 运动加速度：X=0.0, Y=3.0, Z=0.0 m/s²
- **结果**：精确的侧向加速度

## 零速检测改进

### 传统方法：
```cpp
// 使用总加速度检测静止
bool isStationary = (abs(totalAccel - 9.8f) < 0.3f);
```

### 重力补偿方法：
```cpp
// 使用运动加速度检测静止
bool isStationary = (totalMotionAccel < 0.5f);
```

## 优势总结

1. **准确性**：获得纯运动加速度，不受重力干扰
2. **稳定性**：设备倾斜不影响运动检测
3. **可靠性**：零速检测更准确
4. **适用性**：适用于各种安装角度和地形

## 使用建议

1. **默认启用**：重力补偿应该默认开启
2. **姿态更新**：需要实时更新设备姿态角
3. **校准配合**：结合IMU校准获得最佳效果
4. **调试输出**：启用调试查看重力分量和运动加速度
