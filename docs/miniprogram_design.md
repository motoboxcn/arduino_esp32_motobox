# MotoBox 小程序前端设计

## 功能架构

### 数据通信方案
由于轻量化版本移除了BLE功能，小程序通过以下方式获取数据：
- **云端API**: 设备通过4G/MQTT上报数据到云端，小程序调用API获取
- **实时性**: 支持WebSocket推送实时数据更新

### 核心页面结构

#### 1. 仪表盘页面 (主页)

##### 主仪表区域
```
┌─────────────────────────────────────┐
│              数字仪表               │
├─────────────────────────────────────┤
│        [速度表]    [转速表]         │
│          65        4500            │
│         km/h        RPM            │
├─────────────────────────────────────┤
│  档位: 3档    里程: 1234.5 km      │
│  油量: ████░░  电量: ████████ 85%   │
└─────────────────────────────────────┘
```

##### 状态指示区
```
┌─────────────────────────────────────┐
│  🔴ABS  🟢GPS  🟡ENG  ⚪BLE  🔵4G   │
│                                     │
│  倾角: 15°    方向: 东北 45°        │
│  加速度: 0.8G  温度: 25°C          │
├─────────────────────────────────────┤
│           快捷操作                  │
│  [轨迹] [告警] [设置] [更多]       │
└─────────────────────────────────────┘
```

##### 仪表功能特性

**🏍️ 核心仪表**
- **数字速度表** - GPS实时速度
- **里程统计** - 总里程/单次里程  
- **电量显示** - 电池百分比和电压
- **温度监控** - 环境温度显示

**📊 运动数据**
- **实时倾角** - 左右倾斜角度
- **加速度** - 前后/左右G值
- **方向指示** - 数字罗盘显示
- **高度信息** - GPS海拔数据

**⚠️ 状态指示**
- **GPS状态** - 信号强度和定位精度
- **4G连接** - 网络信号和数据传输
- **电量告警** - 低电量红色警示
- **倾角告警** - 过度倾斜警告

**📈 智能功能**
- **自动档位识别** - 基于速度/转速曲线
- **骑行模式检测** - 城市/高速/山路
- **性能分析** - 加速/制动G值记录
- **轨迹记录** - GPS轨迹自动保存

## 数据计算逻辑

### 速度计算
```javascript
// 基于GPS数据
const speed = gpsData.speed; // km/h

// 基于IMU辅助修正 (隧道/信号差时)
const accelerationSpeed = calculateSpeedFromAccel(imuData.acceleration);
const fusedSpeed = fuseSpeedData(speed, accelerationSpeed);
```

### 转速估算
```javascript
// 基于速度和档位估算 (无直接转速传感器)
const estimatedRPM = calculateRPM(speed, currentGear, wheelCircumference);
```

### 倾角显示
```javascript
// 实时倾角 (左右倾斜)
const tiltAngle = Math.atan2(imuData.accel_y, imuData.accel_z) * 180 / Math.PI;

// 压弯角度记录
if (Math.abs(tiltAngle) > 10) {
  recordLeanAngle(tiltAngle, timestamp, location);
}
```

### 方向指示
```javascript
// 基于GPS航向
const heading = gpsData.heading; // 0-360度
const direction = getCompassDirection(heading); // "东北"

// 基于IMU磁力计 (室内/GPS信号差时)
const magneticHeading = calculateMagneticHeading(imuData.magnetometer);
```

#### 2. GPS轨迹页面
```
┌─────────────────────────────────────┐
│              地图显示               │
├─────────────────────────────────────┤
│  当前位置: 北京市朝阳区...          │
│  行驶距离: 15.2 km                 │
│  行驶时间: 1h 25min                │
├─────────────────────────────────────┤
│  [历史轨迹] [轨迹分享] [导出]      │
└─────────────────────────────────────┘
```

#### 3. 震动告警页面
```
┌─────────────────────────────────────┐
│              告警记录               │
├─────────────────────────────────────┤
│  🔴 异常震动 - 2分钟前              │
│  🟡 倾角过大 - 15分钟前             │
│  🟢 系统正常 - 1小时前              │
├─────────────────────────────────────┤
│  告警设置: [震动敏感度] [推送开关]  │
└─────────────────────────────────────┘
```

#### 4. 压弯分析页面
```
┌─────────────────────────────────────┐
│              压弯统计               │
├─────────────────────────────────────┤
│  最大倾角: 45°                     │
│  平均倾角: 12°                     │
│  压弯次数: 23次                    │
├─────────────────────────────────────┤
│  [倾角历史] [骑行分析] [技巧提升]   │
└─────────────────────────────────────┘
```

#### 5. 个人中心页面
```
┌─────────────────────────────────────┐
│          个人信息                   │
├─────────────────────────────────────┤
│  设备状态: 在线                    │
│  固件版本: v5.0.0                  │
│  数据同步: 2分钟前                 │
├─────────────────────────────────────┤
│  [设备管理] [数据导出] [关于]      │
└─────────────────────────────────────┘
```

## 数据刷新频率

| 数据类型 | 刷新频率 | 数据源 |
|---------|---------|--------|
| 速度 | 10Hz | GPS + IMU融合 |
| 倾角 | 50Hz | IMU陀螺仪 |
| 方向 | 5Hz | GPS航向 + 磁力计 |
| 电量 | 1Hz | 电池管理系统 |
| 温度 | 0.1Hz | 环境传感器 |

## 显示优化

### 夜间模式
- 自动亮度调节
- 高对比度配色
- 关键信息突出

### 运动模式
- 大字体速度显示
- 倾角实时图表
- 性能数据记录

### 节能模式
- 降低刷新频率
- 简化显示内容
- 延长电池续航

## 数据结构定义

### 实时数据
```json
{
  "timestamp": 1699776348,
  "location": {
    "lat": 39.9042,
    "lng": 116.4074,
    "speed": 65,
    "heading": 45
  },
  "imu": {
    "tilt_angle": 15,
    "acceleration": [0.1, 0.2, 9.8],
    "gyroscope": [0.01, 0.02, 0.03]
  },
  "system": {
    "battery": 85,
    "temperature": 25,
    "status": "riding"
  }
}
```

### 告警数据
```json
{
  "alert_id": "alert_001",
  "type": "vibration",
  "level": "high",
  "timestamp": 1699776348,
  "message": "检测到异常震动",
  "location": {
    "lat": 39.9042,
    "lng": 116.4074
  }
}
```

## 技术实现要点

### 1. 数据获取
- 云端API轮询 (30秒间隔)
- WebSocket实时推送 (关键告警)
- 本地缓存机制

### 2. 地图集成
- 使用微信小程序地图组件
- 轨迹绘制和回放
- 位置标记和信息展示

### 3. 状态管理
- 设备在线状态检测
- 数据同步状态显示
- 离线数据缓存

### 4. 用户体验
- 简洁直观的界面设计
- 关键信息突出显示
- 快速响应和流畅操作

## 功能限制说明

由于硬件轻量化设计，以下功能不可用：
- ❌ 蓝牙直连控制
- ❌ 实时视频传输
- ❌ 复杂的车机控制
- ❌ 本地WiFi配置

## 开发优先级

### Phase 1 (核心功能)
1. 仪表盘页面
2. GPS轨迹显示
3. 基础数据API

### Phase 2 (增强功能)
1. 告警系统
2. 压弯分析
3. 历史数据

### Phase 3 (完善体验)
1. 个人中心
2. 数据导出
3. 设置优化
