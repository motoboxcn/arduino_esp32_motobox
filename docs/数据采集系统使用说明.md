# ESP32-S3 MotoBox 数据采集系统使用说明

## 概述

ESP32-S3 MotoBox 数据采集系统是一个专为摩托车设计的综合传感器数据采集和传输解决方案。系统能够实时采集GPS位置、IMU运动数据、罗盘航向和系统状态信息，并通过4G网络以MQTT协议传输到云端服务器。

## 核心功能

### 📊 数据采集能力

1. **GPS定位数据**
   - 经纬度坐标（精度6位小数）
   - 海拔高度
   - 行驶速度
   - 行驶航向
   - 卫星数量
   - HDOP精度因子

2. **IMU运动数据统计**
   - 加速度计极值（X/Y/Z轴最大值和最小值）
   - 陀螺仪极值（X/Y/Z轴最大值和最小值）
   - 姿态角极值（横滚角/俯仰角/偏航角最大值和最小值）
   - 统计时间窗口

3. **罗盘航向数据**
   - 磁北航向角（0-360度）
   - 三轴磁场强度（X/Y/Z）

4. **系统状态监控**
   - 电池电压
   - 4G信号强度
   - 系统运行时间
   - 当前工作模式

### 🚀 工作模式

#### 正常模式（Normal Mode）
- **传输频率**: 5秒一次
- **适用场景**: 日常驾驶、城市通勤
- **功耗特点**: 低功耗，延长续航
- **数据特点**: IMU统计5秒周期的极值

#### 运动模式（Sport Mode）
- **传输频率**: 1秒一次
- **适用场景**: 激烈驾驶、赛道测试
- **功耗特点**: 高频传输，实时性强
- **数据特点**: IMU统计1秒周期的极值

## 数据格式

### JSON数据结构

```json
{
  "device_id": "ESP32_XXXXXX",
  "timestamp": 1234567890,
  "mode": "normal",
  "gps": {
    "lat": 39.908823,
    "lng": 116.397470,
    "alt": 45.2,
    "speed": 25.6,
    "course": 135.8,
    "satellites": 12,
    "hdop": 1.2
  },
  "imu_stats": {
    "accel": {
      "x_min": -2.1,
      "x_max": 3.4,
      "y_min": -1.8,
      "y_max": 2.9,
      "z_min": 8.2,
      "z_max": 11.5
    },
    "gyro": {
      "x_min": -45.2,
      "x_max": 67.8,
      "y_min": -23.1,
      "y_max": 34.5,
      "z_min": -12.3,
      "z_max": 18.7
    },
    "attitude": {
      "roll_min": -15.5,
      "roll_max": 12.3,
      "pitch_min": -8.2,
      "pitch_max": 6.7,
      "yaw_min": 120.5,
      "yaw_max": 145.8
    },
    "duration": 5000
  },
  "compass": {
    "heading": 135.8,
    "x": 245.6,
    "y": -123.4,
    "z": 567.8
  },
  "system": {
    "battery": 12.6,
    "signal": 85,
    "uptime": 3600000
  }
}
```

### 字段说明

| 字段 | 类型 | 单位 | 说明 |
|------|------|------|------|
| device_id | String | - | 设备唯一标识 |
| timestamp | Number | ms | 数据时间戳 |
| mode | String | - | normal/sport |
| gps.lat | Number | 度 | 纬度 |
| gps.lng | Number | 度 | 经度 |
| gps.alt | Number | 米 | 海拔 |
| gps.speed | Number | km/h | 速度 |
| gps.course | Number | 度 | 航向 |
| gps.satellites | Number | 个 | 卫星数 |
| gps.hdop | Number | - | 水平精度因子 |
| imu_stats.accel.* | Number | g | 加速度极值 |
| imu_stats.gyro.* | Number | °/s | 角速度极值 |
| imu_stats.attitude.* | Number | 度 | 姿态角极值 |
| imu_stats.duration | Number | ms | 统计时长 |
| compass.heading | Number | 度 | 磁北航向 |
| compass.x/y/z | Number | - | 磁场强度 |
| system.battery | Number | V | 电池电压 |
| system.signal | Number | % | 信号强度 |
| system.uptime | Number | ms | 运行时间 |

## MQTT控制

### 主题结构

- **数据上报**: `vehicle/v1/{device_id}/telemetry/sensors`
- **命令下发**: `vehicle/v1/{device_id}/ctrl/#`

### 控制命令

#### 1. 切换数据采集模式

**切换到正常模式**:
```json
{
  "cmd": "set_data_mode",
  "mode": "normal"
}
```

**切换到运动模式**:
```json
{
  "cmd": "set_data_mode", 
  "mode": "sport"
}
```

#### 2. 数据采集控制

**启动数据采集**:
```json
{
  "cmd": "data_collection",
  "action": "start"
}
```

**停止数据采集**:
```json
{
  "cmd": "data_collection",
  "action": "stop"
}
```

**查看采集统计**:
```json
{
  "cmd": "data_collection",
  "action": "stats"
}
```

## 系统架构

### 数据流程

```
传感器数据采集 (1秒周期)
    ↓
IMU数据极值统计
    ↓
数据缓存和整合
    ↓
JSON格式化
    ↓
MQTT传输 (根据模式: 1秒或5秒)
    ↓
云端服务器接收
```

### 低功耗优化

1. **智能采集频率**
   - 数据采集: 固定1秒周期
   - 数据传输: 根据模式调整

2. **传感器功耗管理**
   - 支持传感器低功耗模式
   - 与PowerManager协调工作

3. **网络优化**
   - 批量数据传输
   - 连接状态检测

## 使用场景

### 🏍️ 日常驾驶监控

**配置**: 正常模式
**用途**: 
- 行驶轨迹记录
- 驾驶习惯分析
- 车辆状态监控
- 长途旅行记录

### 🏁 性能测试分析

**配置**: 运动模式
**用途**:
- 赛道圈速分析
- 加速性能测试
- 过弯G值记录
- 驾驶技术改进

### 🔧 车辆诊断

**配置**: 根据需要切换
**用途**:
- 异常振动检测
- 电池状态监控
- GPS信号质量评估
- 系统稳定性分析

## 调试和监控

### 串口调试信息

```
[数据采集] 初始化开始
[数据采集] 模式: 正常模式(5秒)
[数据采集] 采集间隔: 1000 ms
[数据采集] 传输间隔: 5000 ms
[数据采集] 初始化完成
[数据采集] GPS数据更新: 39.908823,116.397470
[数据采集] IMU数据更新: 加速度(0.123,0.456,9.789)
[数据采集] 罗盘数据更新: 航向 135.8°
[数据采集] 系统数据更新: 电池 12.60V
[数据采集] 数据传输成功: 1024 字节
```

### 统计信息查看

通过MQTT命令或串口可查看：
- 当前工作模式
- 采集和传输状态
- GPS定位状态
- 传感器数据有效性
- 网络连接状态

## 故障排除

### 常见问题

1. **GPS数据无效**
   - 检查天线连接
   - 确认室外环境
   - 等待卫星搜索

2. **IMU数据异常**
   - 检查传感器连接
   - 确认I2C通信
   - 重启系统初始化

3. **MQTT传输失败**
   - 检查4G网络连接
   - 确认MQTT服务器状态
   - 检查设备ID配置

4. **模式切换无响应**
   - 确认MQTT连接正常
   - 检查命令格式
   - 查看串口错误信息

### 性能优化建议

1. **提高GPS精度**
   - 使用高质量GPS天线
   - 避免金属遮挡
   - 等待充分的卫星锁定

2. **优化传输效率**
   - 根据使用场景选择合适模式
   - 监控网络信号强度
   - 定期检查数据完整性

3. **延长电池续航**
   - 优先使用正常模式
   - 启用低功耗传感器模式
   - 合理设置休眠时间

## 技术规格

- **数据采集频率**: 1Hz
- **数据传输频率**: 0.2Hz (正常) / 1Hz (运动)
- **GPS精度**: ±3米 (开阔环境)
- **IMU精度**: 16位ADC
- **罗盘精度**: ±2度
- **传输协议**: MQTT over 4G
- **数据格式**: JSON
- **功耗**: 200-500mA (工作) / 10-100μA (休眠)

## 更新日志

- **v4.2.0**: 完整数据采集系统实现
- **v4.1.0**: 支持SD卡升级功能
- **v4.0.0**: Air780EG模块集成
- **v2.3.0**: ML307模块支持
- **v2.2.0**: MQTT配置支持

---

**注意**: 本系统需要配合云端MQTT服务器使用，请确保网络连接正常且服务器配置正确。
