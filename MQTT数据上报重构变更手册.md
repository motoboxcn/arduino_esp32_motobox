# MQTT数据上报重构变更手册

## 📋 变更概述

本次重构将原本分离的MQTT主题合并为单一主题，数据结构从扁平结构改为嵌套结构。订阅服务需要相应调整以适配新的数据格式。

## 🔄 主要变更

### 1. MQTT主题变更

**变更前：**
- `vehicle/v1/{device_id}/location` - 位置数据
- `vehicle/v1/{device_id}/device_status` - 设备状态

**变更后：**
- `vehicle/v1/{device_id}/telemetry` - 统一遥测数据

### 2. 数据格式变更

#### 变更前 - 分离的JSON格式

**位置数据 (location主题):**
- 包含设备ID、时间戳、经纬度、海拔、速度、航向、卫星数、HDOP等字段
- 数据结构扁平，字段名如 `latitude`, `longitude`, `altitude` 等

**设备状态 (device_status主题):**
- 包含设备ID、时间戳、电池信息、系统状态、模块状态等字段
- 数据结构扁平，字段名如 `battery_voltage`, `battery_percentage`, `is_charging` 等

#### 变更后 - 统一嵌套JSON格式

**新的数据结构包含以下主要部分：**

1. **设备基础信息**
   - 设备ID、时间戳、固件版本、硬件版本、功耗模式

2. **位置数据 (location)**
   - 经纬度、海拔、速度、航向、卫星数、HDOP等
   - 字段名变更：`latitude` → `lat`, `longitude` → `lng`, `altitude` → `alt`

3. **传感器数据 (sensors)**
   - **IMU数据 (imu)**: 加速度、陀螺仪、姿态角等
   - **罗盘数据 (compass)**: 航向、磁场强度等

4. **系统状态 (system)**
   - 电池信息、充电状态、外部电源、信号强度、运行时间、内存使用等
   - 字段名变更：`battery_voltage` → `battery`, `battery_percentage` → `battery_pct`, `is_charging` → `charging`

5. **模块状态 (modules)**
   - WiFi、BLE、GSM、GNSS、IMU、罗盘、SD卡、音频等模块的就绪状态
   - 字段名变更：`wifi_ready` → `wifi`, `ble_ready` → `ble` 等

6. **存储信息 (storage)**
   - SD卡大小和剩余空间信息

## 🛠 订阅服务适配指南

### 1. 主题订阅更新

订阅服务需要将原来的两个主题订阅合并为一个：
- 移除对 `location` 和 `device_status` 主题的订阅
- 添加对 `telemetry` 主题的订阅

### 2. 数据解析更新

**主要变更点：**

1. **字段名变更**
   - 位置数据：`latitude` → `lat`, `longitude` → `lng`, `altitude` → `alt`
   - 电池数据：`battery_voltage` → `battery`, `battery_percentage` → `battery_pct`, `is_charging` → `charging`
   - 模块状态：所有 `xxx_ready` → `xxx`

2. **数据结构变更**
   - 从扁平结构改为嵌套结构
   - 需要按层级访问数据：`payload.location.lat` 而不是 `payload.latitude`

3. **新增数据字段**
   - 固件版本、硬件版本、功耗模式
   - IMU详细数据（加速度、陀螺仪、姿态角）
   - 罗盘详细数据（磁场强度）
   - 存储信息

### 3. 数据库表结构更新

**需要更新的表：**

1. **位置数据表**
   - 字段名变更：`latitude` → `lat`, `longitude` → `lng`, `altitude` → `alt`
   - 移除 `valid` 字段（改为通过数据存在性判断）

2. **设备状态表**
   - 字段名变更：`battery_voltage` → `battery`, `battery_percentage` → `battery_pct`, `is_charging` → `charging`
   - 模块状态字段名变更：`wifi_ready` → `wifi` 等
   - 新增字段：`firmware`, `hardware`, `power_mode`

3. **新增表**
   - **IMU数据表**：存储加速度、陀螺仪、姿态角数据
   - **罗盘数据表**：存储航向和磁场强度数据
   - **存储信息表**：存储SD卡大小和剩余空间

### 4. 数据插入逻辑更新

**主要变更：**

1. **单次消息处理多个数据表**
   - 原来需要处理两个独立的消息
   - 现在一个消息包含所有数据，需要分别插入到不同表中

2. **数据完整性检查**
   - 需要检查嵌套数据的存在性
   - 某些数据可能不存在（如IMU数据在模块未就绪时）

3. **时间戳处理**
   - 统一使用消息根级别的时间戳
   - 各子数据使用各自的时间戳（如果存在）

## 📊 性能影响

### 优势

1. **减少MQTT消息数量**
   - 从2个消息减少到1个消息
   - 减少约30%的AT命令使用

2. **数据一致性提升**
   - 所有数据在同一时间点采集
   - 避免不同消息间的时间差

3. **网络效率提升**
   - 减少MQTT连接开销
   - 减少消息头开销

### 注意事项

1. **消息大小增加**
   - 单个消息包含更多数据
   - 需要确保MQTT消息大小限制

2. **解析复杂度增加**
   - 需要处理嵌套JSON结构
   - 需要检查数据存在性

## 🔧 迁移建议

### 1. 渐进式迁移

1. **第一阶段**：同时支持新旧格式
   - 订阅服务同时处理两种格式
   - 逐步迁移数据处理逻辑

2. **第二阶段**：完全切换到新格式
   - 移除对旧格式的支持
   - 优化数据处理逻辑

### 2. 数据验证

1. **格式验证**
   - 验证JSON结构完整性
   - 验证必需字段存在性

2. **数据范围验证**
   - 验证数值字段的合理范围
   - 验证枚举字段的有效值

### 3. 错误处理

1. **数据缺失处理**
   - 某些传感器数据可能不存在
   - 需要优雅处理缺失数据

2. **格式错误处理**
   - 处理JSON解析错误
   - 处理字段类型不匹配

## 📝 总结

本次重构将MQTT数据上报从分离主题改为统一主题，数据结构从扁平改为嵌套。主要变更包括：

- **主题合并**：2个主题 → 1个主题
- **结构嵌套**：扁平结构 → 嵌套结构  
- **字段重命名**：部分字段名简化
- **数据扩展**：新增IMU、罗盘、存储等详细信息

订阅服务需要相应调整数据解析逻辑，数据库表结构需要更新以适配新的数据格式。重构后系统将具有更好的数据一致性和网络效率。
