# ESP32-S3 MotoBox SD卡OTA升级功能

## 🎯 功能概述

SD卡OTA升级功能允许通过SD卡中的固件文件对设备进行离线升级。设备启动时会自动检测SD卡中的固件文件，如果版本更新且电池电量充足，会自动执行升级。

## ✅ 升级条件

系统会自动检查以下条件，**所有条件都满足**才会执行升级：

1. **电池电量** ≥ 90%
2. **新版本号** > 当前版本号  
3. **SD卡中存在** `firmware.bin` 文件
4. **SD卡中存在** `version.txt` 文件

## 📁 文件准备

在SD卡根目录放置以下文件：

```
SD卡根目录/
├── firmware.bin    # 固件文件
└── version.txt     # 版本号文件
```

### version.txt 格式
文件内容为版本号，支持以下格式：
- `v4.1.0`
- `4.1.0` 
- `v4.1.0+123`

## 🔧 使用工具

使用提供的测试工具创建升级文件：

```bash
# 创建升级文件
python3 tools/sd_ota_test.py --create --firmware firmware.bin --version v4.1.0

# 显示升级指南
python3 tools/sd_ota_test.py --guide

# 验证固件文件
python3 tools/sd_ota_test.py --validate --firmware firmware.bin
```

## 🔄 升级流程

1. **设备启动** - 系统自动检测SD卡
2. **文件检查** - 检查 `firmware.bin` 和 `version.txt` 是否存在
3. **版本比较** - 比较SD卡版本与当前版本
4. **电量检查** - 确认电池电量 ≥ 90%
5. **开始升级** - 播放3声短促提示音
6. **升级进行** - 播放2声中等提示音，每20%进度播放一次提示
7. **升级完成** - 播放上升音调，设备自动重启

## 🎵 语音提示

| 提示音 | 含义 | 描述 |
|--------|------|------|
| 🔊 3声短促音 | 开始升级 | 检测到新固件，条件满足，开始升级 |
| 🔊 2声中等音 | 升级进行中 | 正在写入固件数据 |
| 🔊 上升音调 | 升级成功 | 固件升级完成，即将重启 |
| 🔊 长声低音 | 升级失败 | 升级过程出错 |
| 🔊 单声短促 | 进度提示 | 每20%进度播放一次 |

## ⚠️ 注意事项

1. **升级过程中请勿断电** - 可能导致设备无法启动
2. **升级过程中请勿移除SD卡** - 会导致升级失败
3. **确保电池电量充足** - 低于90%会拒绝升级
4. **版本号格式要正确** - 使用标准的语义化版本号
5. **固件文件要完整** - 确保固件文件没有损坏

## 🔍 故障排除

### 常见问题

**Q: 设备不升级，没有提示音**
- 检查SD卡是否正确插入
- 确认 `firmware.bin` 和 `version.txt` 文件存在
- 检查版本号是否比当前版本新
- 确认电池电量是否 ≥ 90%

**Q: 听到长声低音（升级失败）**
- 检查固件文件是否完整
- 确认固件文件大小合理（通常1-2MB）
- 检查SD卡是否有足够空间

**Q: 升级后设备无法启动**
- 这种情况很少见，系统有自动回滚机制
- 如果发生，请联系技术支持

### 调试信息

系统会输出详细的调试信息到串口：

```
[SDCardOTA] SD卡OTA升级模块初始化
[SDCardOTA] 当前版本: v4.0.0+695
[SDCardOTA] 开始检查SD卡升级
[SDCardOTA] SD卡固件版本: v4.1.0
[SDCardOTA] 当前固件版本: v4.0.0+695
[SDCardOTA] 当前电池电量: 95%
[SDCardOTA] ✅ 所有升级条件满足，开始升级
[SDCardOTA] 🔄 开始从SD卡升级固件
[SDCardOTA] 固件文件大小: 1082624 字节
[SDCardOTA] 升级进度: 20%
[SDCardOTA] 升级进度: 40%
[SDCardOTA] 升级进度: 60%
[SDCardOTA] 升级进度: 80%
[SDCardOTA] 升级进度: 100%
[SDCardOTA] ✅ 固件升级成功！写入 1082624 字节
[SDCardOTA] 🔄 设备即将重启...
```

## 📊 技术规格

- **支持的固件大小**: 100KB - 10MB
- **支持的SD卡格式**: FAT32
- **升级时间**: 约30-60秒（取决于固件大小）
- **内存占用**: 约5KB RAM
- **电池要求**: ≥90%电量

## 🔒 安全特性

1. **电池保护** - 低电量时拒绝升级
2. **版本验证** - 防止降级和重复升级
3. **完整性检查** - 验证固件文件大小和格式
4. **自动回滚** - 升级失败时保持原固件可用
5. **状态管理** - 防止升级过程中的意外中断

## 📈 使用统计

编译后的资源使用情况：
- **RAM使用**: 12.8% (41804/327680 bytes)
- **Flash使用**: 54.8% (1076857/1966080 bytes)

升级功能对系统资源占用很小，不会影响设备的正常运行。
