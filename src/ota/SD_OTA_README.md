# ESP32-S3 MotoBox SD卡OTA升级功能

## 🎯 功能概述

SD卡OTA升级功能允许通过SD卡中的固件文件对设备进行离线升级。系统支持**多个固件文件共存**，会自动扫描并选择**最新版本**进行升级。设备启动时会自动检测SD卡中的固件文件，如果版本更新且电池电量充足，会自动执行升级。

## ✨ 新特性：多固件支持

- 🔍 **智能扫描**：自动扫描SD卡中所有支持的固件文件
- 📊 **版本比较**：自动比较版本号，选择最新版本
- 📁 **多种格式**：支持多种固件文件命名格式
- 🎯 **自动选择**：无需手动指定，系统自动选择最佳固件

## ✅ 升级条件

系统会自动检查以下条件，**所有条件都满足**才会执行升级：

1. **电池电量** ≥ 90%
2. **新版本号** > 当前版本号  
3. **SD卡中存在**有效的固件文件

## 📁 支持的固件文件格式

### 1. 标准格式
```
firmware.bin        # 固件文件
version.txt         # 版本号文件（内容：v4.1.0）
```

### 2. 嵌入版本格式
```
firmware_v4.1.0.bin     # 版本号嵌入文件名
firmware_v4.2.0.bin     # 可以有多个版本
```

### 3. MotoBox格式
```
motobox_v4.1.0.bin      # MotoBox专用格式
motobox_v4.2.0.bin      # 支持多版本
```

### 4. ESP32格式
```
esp32_v4.1.0.bin        # ESP32通用格式
esp32_v4.2.0.bin        # 支持多版本
```

### 5. 混合格式（推荐）
```
SD卡根目录/
├── firmware.bin            # v4.0.0 (标准格式)
├── version.txt             # 内容：v4.0.0
├── firmware_v4.1.0.bin     # v4.1.0 (嵌入格式)
├── motobox_v4.2.0.bin      # v4.2.0 (MotoBox格式)
└── esp32_v4.3.0.bin        # v4.3.0 (ESP32格式)
```
**系统会自动选择v4.3.0进行升级（最新版本）**

## 🔧 使用工具

### 创建单个固件文件
```bash
# 标准格式
python3 tools/sd_ota_test.py --create --firmware firmware.bin --version v4.1.0

# 嵌入版本格式
python3 tools/sd_ota_test.py --create --firmware firmware.bin --version v4.1.0 --style embedded

# MotoBox格式
python3 tools/sd_ota_test.py --create --firmware firmware.bin --version v4.1.0 --style motobox
```

### 创建多个版本固件
```bash
# 一次创建多个版本（推荐）
python3 tools/sd_ota_test.py --create-multi --firmware firmware.bin --versions v4.0.0,v4.1.0,v4.2.0
```

### 其他工具功能
```bash
# 显示升级指南
python3 tools/sd_ota_test.py --guide

# 验证固件文件
python3 tools/sd_ota_test.py --validate --firmware firmware.bin

# 显示使用示例
python3 tools/sd_ota_test.py --examples
```

## 🔄 升级流程

### 1. 扫描阶段
- 系统启动时自动扫描SD卡
- 识别所有支持的固件文件格式
- 提取每个文件的版本号信息

### 2. 选择阶段
- 比较所有找到的固件版本号
- 自动选择版本号最高的固件
- 显示选择的固件信息

### 3. 验证阶段
- 检查选择的固件版本是否比当前版本新
- 验证电池电量是否≥90%
- 确认固件文件完整性

### 4. 升级阶段
- 播放开始升级提示音
- 实时显示升级进度
- 每20%播放进度提示音

### 5. 完成阶段
- 播放升级成功提示音
- 显示升级统计信息
- 自动重启到新版本

## 🎵 语音提示

| 提示音 | 含义 | 描述 |
|--------|------|------|
| 🔊 3声短促音 | 开始升级 | 找到新固件，条件满足，开始升级 |
| 🔊 2声中等音 | 升级进行中 | 正在写入固件数据 |
| 🔊 上升音调 | 升级成功 | 固件升级完成，即将重启 |
| 🔊 长声低音 | 升级失败 | 升级过程出错 |
| 🔊 单声短促 | 进度提示 | 每20%进度播放一次 |

## 📊 升级日志示例

```
[SDCardOTA] 开始检查SD卡升级
[SDCardOTA] 🔍 扫描SD卡中的固件文件...
[SDCardOTA] ✅ 找到固件: firmware.bin (版本: v4.0.0, 大小: 1088560 字节)
[SDCardOTA] ✅ 找到固件: firmware_v4.1.0.bin (版本: v4.1.0, 大小: 1088560 字节)
[SDCardOTA] ✅ 找到固件: motobox_v4.2.0.bin (版本: v4.2.0, 大小: 1088560 字节)
[SDCardOTA] 📊 扫描完成，找到 3 个有效固件文件
[SDCardOTA] 📋 找到的固件文件列表:
[SDCardOTA]   1. firmware.bin (版本: v4.0.0, 大小: 1.0 MB)
[SDCardOTA]   2. firmware_v4.1.0.bin (版本: v4.1.0, 大小: 1.0 MB)
[SDCardOTA]   3. motobox_v4.2.0.bin (版本: v4.2.0, 大小: 1.0 MB)
[SDCardOTA] 选择的固件: motobox_v4.2.0.bin (版本: v4.2.0)
[SDCardOTA] 当前电池电量: 95%
[SDCardOTA] ✅ 所有升级条件满足，开始升级到版本: v4.2.0
[SDCardOTA] 🔄 开始升级固件: motobox_v4.2.0.bin
[SDCardOTA] 📦 固件版本: v4.2.0
[SDCardOTA] 📏 文件大小: 1088560 字节
[SDCardOTA] 升级进度: 20% (217712/1088560 字节)
[SDCardOTA] 升级进度: 40% (435424/1088560 字节)
[SDCardOTA] 升级进度: 60% (653136/1088560 字节)
[SDCardOTA] 升级进度: 80% (870848/1088560 字节)
[SDCardOTA] 升级进度: 100% (1088560/1088560 字节)
[SDCardOTA] ✅ 固件升级成功！
[SDCardOTA] 📊 升级统计:
[SDCardOTA]   - 源文件: motobox_v4.2.0.bin
[SDCardOTA]   - 版本: v4.0.0+695 → v4.2.0
[SDCardOTA]   - 写入字节: 1088560/1088560
[SDCardOTA] 🔄 设备即将重启到新版本...
```

## ⚠️ 注意事项

1. **升级过程中请勿断电** - 可能导致设备无法启动
2. **升级过程中请勿移除SD卡** - 会导致升级失败
3. **确保电池电量充足** - 低于90%会拒绝升级
4. **版本号格式要正确** - 使用标准的语义化版本号
5. **固件文件要完整** - 确保固件文件没有损坏
6. **系统自动选择最新版本** - 无需手动指定固件文件

## 🔍 故障排除

### 常见问题

**Q: 设备不升级，没有提示音**
- 检查SD卡是否正确插入
- 确认至少有一个有效的固件文件
- 检查版本号是否比当前版本新
- 确认电池电量是否 ≥ 90%

**Q: 找到多个固件但不升级**
- 检查所有固件版本是否都比当前版本旧
- 确认版本号格式是否正确
- 查看串口日志了解具体原因

**Q: 听到长声低音（升级失败）**
- 检查固件文件是否完整
- 确认固件文件大小合理（通常1-2MB）
- 检查SD卡是否有足够空间

## 📈 优势特点

### 相比单固件模式
1. **更灵活**：支持多个版本共存
2. **更智能**：自动选择最新版本
3. **更方便**：无需删除旧固件文件
4. **更安全**：多重版本验证

### 使用场景
1. **开发测试**：可以放置多个测试版本
2. **生产部署**：支持渐进式版本升级
3. **维护更新**：方便版本管理和回退
4. **批量升级**：一次准备多个版本

## 📊 技术规格

- **支持的固件大小**: 100KB - 10MB
- **支持的SD卡格式**: FAT32
- **升级时间**: 约30-60秒（取决于固件大小）
- **内存占用**: 约6KB RAM
- **电池要求**: ≥90%电量
- **支持的版本格式**: v4.0.0, 4.0.0, v4.0.0+694

## 🔒 安全特性

1. **电池保护** - 低电量时拒绝升级
2. **版本验证** - 防止降级和重复升级
3. **完整性检查** - 验证固件文件大小和格式
4. **自动回滚** - 升级失败时保持原固件可用
5. **智能选择** - 自动选择最安全的升级路径

多固件支持让SD卡OTA升级功能更加强大和灵活，特别适合需要管理多个固件版本的场景。
